---
layout: post
title: MEV transaction analysis - a sandwich attack
tags: [Block Chain]
image:
  path: /assets/img/blog/sandwich.jpeg
description: >
  利用[Eigenphi.io](https://eigenphi.io)研究MEV交易时的分析case (photo taken in Perth, 2019)
sitemap: false
---

- Table of Contents
{:toc .large-only}

### Introduction
MEV ([0x8cfbb935a8461e8681ac1e06b760530d824f6ef085a07e7ac49121eaee3cbe5a](https://eigenphi.io)),
is a sandwich-attach transaction discussed as an 
[#AwesomeTx](https://github.com/eigenphi/AwesomeTx/issues/11) on github.
It is also the first bundle packed in block 14811888 (before the Merge) by [Flashbot](https://flashbots-explorer.marto.lol/?block=14811888).

![Full-width image](/assets/img/blog/mevbundle.png)

### [The front-running transaction](https://etherscan.io/tx/0xada54289d2a5556b2aa8f6ca26317a0649397fff8babd7a5bb6f6270815c8a8e)

![Full-width image](https://tx.eigenphi.io/analyseTransaction.svg?chain=ethereum&tx=0xada54289d2a5556b2aa8f6ca26317a0649397fff8babd7a5bb6f6270815c8a8e&rankdir=LR)

- After having monitored a USDC/USDT swap transaction,
the attacker borrowed a 131,705 WETH flah loan (6,20),
and collateralized the WETHs borrowed together with his own 2,423 WETH (0,5,8), 
to further borrow 145,000,000 DAI (11)

- The DAIs borrowed were then swapped for 144,513,418 USDC in Curve Pool (12,13),
lowering the USDC/DAI, as well as the USDC/USDT rate

- The USDC swapped out in the last step was then swapped into 144,513,418 DAI
to repay part of the 145,000,000 DAI debt.
After withdrawing 131,705 WETH from collateral to replay the flash loan,
486,582 DAI debt is left with 2423 WETH collateralized.

### [The victim transaction](https://etherscan.io/tx/0x29afdc352692a037a80d871fce20dd7515b70313860a63220c57529022ab22c7)
![Full-width image](https://tx.eigenphi.io/analyseTransaction.svg?chain=ethereum&tx=0x29afdc352692a037a80d871fce20dd7515b70313860a63220c57529022ab22c7&rankdir=LR)

- The victim paid much more USDTs for USDCs in Curve Pool than in other LPs (8-11)

### [The back-running transaction](https://etherscan.io/tx/0x125f8af2870daa4b00f55e3b6b2d368a409e3b056b1ab6a2dbbcd1a554bd79e1)
![Full-width image](https://tx.eigenphi.io/analyseTransaction.svg?chain=ethereum&tx=0x125f8af2870daa4b00f55e3b6b2d368a409e3b056b1ab6a2dbbcd1a554bd79e1&rankdir=LR)

- Basically the same as [The front-running transaction](#the-front-running-transaction)
the front-running transaction but acting in a reversed way.
In the beginning, the attacker borrowed a 131,705 WETH flash loan (1,18) 
and took it as collateral to borrow 144,513,418 USDS (6)

- The borrowed USDCs were then swapped into 145,078,476 DAI in Curve Pool

- After repaying the 486,582 DAI debt (10) and the new USDC debt (11,13,15),
the attacker got back 134,129 WETH from collateral, which consists of 131,705 WETH flash loan
and the attacker's own 2,423 WETH

- The attacker then repaid the flash loan and earned 78,476 DAI (20) as a profit from sandwich attack

- After paying the miner 1.973 ETH by Coinbase Transfer, the attacker's net profit is 37.634 ETH
