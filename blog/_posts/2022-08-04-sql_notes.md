---
layout: post
title: SQL Notes
tags: [SQL,Data Analysis]
image:
  path: /assets/img/blog/cat_0804.jpeg
description: >
  工作中遇到的一些技巧性SQL语句，但可能不适用于所有方言，实际使用时需要小心
sitemap: false
---

快速定位：[窗口函数](#窗口函数), [行列互换](#行列互换)

- Table of Contents
{:toc .large-only}

## 窗口函数

### distinct的替代和滚动计数

- 快手笔试题：利用登录表login的dt(日期时间)、user_id字段，输出新表，列为day(日期)，以及距day最近30天的总uv
~~~sql
select distinct a.day, a.uv from
(select date_format(dt, '%Y-%m-%d') as day
, user_id
, size(collect_set(user_id) over (order by date_format(dt, '%Y-%m-%d') 
	range between interval 30 day preceeding and interval 1 day preceeding)) as uv
from login) a
~~~

亮点是用size(collect_set)解决窗口函数不能用distinct的问题，其他的方法还有如dense_rank, 但需排序两次，有些复杂:

~~~sql
select day, dense_rank(user_id) over (order by date)
+ dense_rank(user_id) over (order by date desc)-1 as uv
from login
~~~

## 行列互换

### 生成查询只排除某列的sql 
(以下编译自[postgresql在线编辑器](https://extendsclass.com/postgresql-online.html))

~~~sql
create table if not exists scientist (id integer, firstname varchar(100), lastname varchar(100));
		insert into scientist (id, firstname, lastname) values (1, 'albert', 'einstein');
		insert into scientist (id, firstname, lastname) values (2, 'isaac', 'newton');
		insert into scientist (id, firstname, lastname) values (3, 'marie', 'curie');
		select * from scientist;
        
select 'select '||array_to_string(array(select column_name from information_schema.columns 
where table_name='scientist' and column_name not in ('id')),',')||' from scientist'
~~~

其中
- array实现列转行
- array_to_string以','为间隔拼接字符串
- `||`拼接字符串，效果和concat()相同但更简洁
